<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wardrobe</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Dancing+Script:wght@400;700&family=Montserrat:wght@400;700&family=Lora:wght@400;700&display=swap" rel="stylesheet">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">

  <link rel="stylesheet" href="/css/style.css">
  
</head>

<body>
  
  <%- include('partials/navbar') %>
  <div class="container mt-5">
    <h2>Refer & Earn</h2>
    <p>Share your referral code with a friend and get exciting offers!</p>

    <!-- Show Referral Code -->
    <% if (userReferralCode) { %>
        <div class="alert alert-info">
            <p>Your Referral Code: <strong><%= userReferralCode %></strong></p>
            <button class="btn btn-primary" 
                    onclick="copyReferralCode('<%= userReferralCode %>')" 
                    id="copyButton"> 
                Copy Code
            </button>
        </div>
    <% } %>

    <!-- If Referral Code Already Used -->
    <% if (user.referredBy) { %>
        <div class="alert alert-warning">
            <p>You have already used a referral code.</p>
        </div>
    <% } %>

    <!-- New Users - Enter Referral Code (Only if showReferralBox is true) -->
    <% if (showReferralBox) { %>
        <div class="mt-4">
            <label for="referralInput">Enter Referral Code:</label>
            <input type="text" id="referralInput" class="form-control" placeholder="Enter code here">
            <button class="btn btn-success mt-2" onclick="applyReferralCode()">Apply</button>
        </div>
    <% } %>

    <!-- Show Coupon Details for Referred User -->
    <% if (referredCoupon) { %>
        <div class="alert alert-success mt-4">
            <p>ğŸ‰ You have unlocked a special discount: <strong><%= referredCoupon.discountValue %>% OFF</strong>!(Active till your next order)</p>
        </div>
    <% } %>

    <!-- Show Coupon Details for Referrer -->
    <% if (referrerCoupon) { %>
        <div class="alert alert-info mt-4">
            <p>ğŸ’° Someone used your referral code! You have earned: <strong><%= referrerCoupon.discountValue %>% OFF</strong></p>
        </div>
    <% } %>

    <% if (referrerCoupon) { %>
        <p>ğŸ You have received a Reward Coupon for referring someone: <strong><%= referrerCoupon.code %></strong></p>
    <% } %>
    
    <% if (rewardCoupon) { %>
        <div class="alert alert-success mt-4">
            <p>ğŸŒŸ Since you gave a referral code, you also received a Reward Coupon: <strong><%= rewardCoupon.code %></strong>,<strong><%= rewardCoupon.discountValue %>% OFF</strong>(Active till your next order)</p>
           
        </div>
        <% } %>    
</div>


<script>
    function copyReferralCode(code) {
        navigator.clipboard.writeText(code).then(() => {
            alert("Referral code copied!");
        });
    }

    async function applyReferralCode() {
        const referralCode = document.getElementById("referralInput").value;

        if (!referralCode) {
            Swal.fire({
                icon: "warning",
                title: "Oops...",
                text: "Please enter a referral code!"
            });
            return;
        }

        try {
            const response = await fetch('/product/refer/apply-referral', {
                method: "POST",
                body: JSON.stringify({ referralCode: referralCode }),
                headers: { "Content-Type": "application/json" }
            });

            const data = await response.json();

            if (data.referralCodeUsed) {
                Swal.fire({
                    icon: "error",
                    title: "Oops...",
                    text: "This referral code has already been used!"
                }).then(() => {
                    window.location.reload();
                });
            } else if (data.message.includes("Referral code applied successfully")) {
                Swal.fire({
                    icon: "success",
                    title: "Success!",
                    text: "Referral code applied! You and your friend received a discount coupon."
                }).then(() => {
                    window.location.reload();
                });
            } else {
                Swal.fire({
                    icon: "info",
                    title: "Note",
                    text: data.message || "Something went wrong!"
                }).then(() => {
                    window.location.reload();
                });
            }
        } catch (error) {
            console.error("Error applying referral code:", error);
            Swal.fire({
                icon: "error",
                title: "Error!",
                text: "Something went wrong while applying the referral code."
            }).then(() => {
                window.location.reload();
            });
        }
    }
    async function applyReferralCode() {
        const referralCode = document.getElementById("referralInput").value;

        if (!referralCode) {
            Swal.fire({
                icon: "warning",
                title: "Oops...",
                text: "Please enter a referral code!"
            });
            return;
        }

        try {
            const response = await fetch('/product/refer/apply-referral', {
                method: "POST",
                body: JSON.stringify({ referralCode: referralCode }),
                headers: { "Content-Type": "application/json" }
            });

            const data = await response.json();

            if (data.status === "error") {
                Swal.fire({
                    icon: "error",
                    title: "Oops...",
                    text: data.message
                }).then(() => {
                    window.location.reload();
                });
            } else if (data.status === "success") {
                Swal.fire({
                    icon: "success",
                    title: "Success!",
                    text: data.message
                }).then(() => {
                    window.location.reload();
                });
            }
        } catch (error) {
            console.error("Error applying referral code:", error);
            Swal.fire({
                icon: "error",
                title: "Error!",
                text: "Something went wrong while applying the referral code."
            }).then(() => {
                window.location.reload();
            });
        }
    }
</script>
</body>
</html>


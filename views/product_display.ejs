<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wardrobe</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>
    <%- include('partials/navbar') %>
      <nav aria-label="breadcrumb">
        <ul class="breadcrumb">
          <li class="breadcrumb-item"><a href="/product/home">Home</a></li>
      
          <% if (offerId) { %>
              <li class="breadcrumb-item">
                  <a href="/product/offer/<%= offerId %>">
                      <%= offerName %>
                  </a>
              </li>
          <% } else { %>
            <% if ((categoryIds.length > 0 && categoryIds[0] !== 'all') || (filterTags.length > 0 && filterTags[0] !== 'all')) { %>
                <% categoryIds.forEach(categoryId => { %>
                    <li class="breadcrumb-item">
                        <a href="/product/category/<%= categoryId %>">
                            <%= categories.find(cat => cat._id == categoryId)?.name || "Category" %>
                        </a>
                    </li>
                <% }) %>
            
                <% filterTags.forEach(tag => { %>
                    <li class="breadcrumb-item">
                        <a href="/products?tag=<%= tag %>">
                            <%= tagList.find(t => t._id == tag)?.name || "Tag" %>
                        </a>
                    </li>
                <% }) %>
            <% } %>
               
              <% if (brandName) { %>
                  <li class="breadcrumb-item">
                      <a href="/product/brand/<%= brandName %>">
                          <%= brandName %>
                      </a>
                  </li>
              <% } %>
          <% } %>
      </ul>
      
    </nav>
    <div class="container">
        <div class="row">
            <button id="toggleFilters" class="wishlistbutton d-md-none">Show Filters</button>

            <!-- Left Sidebar: Filters -->
            <div class="col-md-3">
                <form id="filterForm" action="/product/filter" method="GET">
                    <div id="filtersContainer" class="filters d-none d-md-block">
                        <h3>Filters</h3>
    
                        <!-- Category Filter -->
                        <h4>CATEGORY</h4>
                        <input type="checkbox" name="category" value="all" <%= categoryId === 'all' ? 'checked' : '' %>> All<br>
                        <% categories.forEach(category => { %>
                            <input type="checkbox" name="category" value="<%= category._id %>" <%= Array.isArray(categoryIds) && categoryIds.includes(category._id) ? 'checked' : '' %>> <%= category.name %><br>
                        <% }) %>
                        
                        <!-- Price Filter -->
                        <h4>PRICE</h4>
                        <input type="checkbox" name="price" value="0-500" <%= price.includes("0-500") ? 'checked' : '' %>> Below ₹500<br>
                        <input type="checkbox" name="price" value="500-2000" <%= price.includes("500-2000") ? 'checked' : '' %>> ₹500 - ₹2000<br>
                        <input type="checkbox" name="price" value="2000-6000" <%= price.includes("2000-6000") ? 'checked' : '' %>> ₹2000 - ₹6000<br>
                        
                        <!-- Size Filter -->
                        <h4>SIZE</h4>
                        <input type="checkbox" name="size" value="S" <%= size.includes("S") ? 'checked' : '' %>> S<br>
                        <input type="checkbox" name="size" value="M" <%= size.includes("M") ? 'checked' : '' %>> M<br>
                        <input type="checkbox" name="size" value="L" <%= size.includes("L") ? 'checked' : '' %>> L<br>
                        
                        <!-- Color Filter -->
                        <h4>COLOR</h4>
                        <% colors.forEach(color => { %>
                            <input type="checkbox" name="color" value="<%= color %>" <%= colorSelected.includes(color) ? 'checked' : '' %>> <%= color %><br>
                        <% }) %>
                        
                        <!-- Sort Option -->
                        <h4>SORT BY</h4>
                        <select id="sortOption" name="sort">
                            <option value="priceLow" <%= sortOption === 'priceLow' ? 'selected' : '' %>>Price: Low to High</option>
                            <option value="priceHigh" <%= sortOption === 'priceHigh' ? 'selected' : '' %>>Price: High to Low</option>
                            <option value="newArrival" <%= sortOption === 'newArrival' ? 'selected' : '' %>>New Arrivals</option>
                            <option value="bestSeller" <%= sortOption === 'bestSeller' ? 'selected' : '' %>>Best Sellers</option>
                        </select>
    
                        <button type="submit">Apply Filter</button>
                    </div>
                </form>
            </div>
    
            <!-- Right Side: Products Display -->
            <div class="col-md-9">
               <!-- Category or Brand Title -->
               <% if (categoryIds && categoryIds.length > 0 && categoryIds[0] !== 'all') { %>
                <h2>Products in 
                    <%= categoryIds.map(categoryId => {
                        const category = categories.find(cat => cat._id == categoryId);
                        return category ? category.name : 'Unknown Category';
                    }).join(', ') %>
                </h2>
            <% } else if (brandName) { %>
                <h2>Products from Brand: <%= brandName %></h2>
            <% } else { %>
                <h2>All Products</h2>
            <% } %>
              <div class="products productdisplay">
                <% products.forEach(product => { %>
                    <div class="product-card productscard">
                      <div class="product-image productImg">
                        <% product.imageUrls.forEach((imageUrl, index) => { %>
                            <img src="<%= '/uploads/' + imageUrl.replace(/^uploads\\/, '').replace(/\\/g, '/').replace(/ /g, '%20') %>" 
                                alt="<%= product.productName %>" 
                                class="product-slide <%= index === 0 ? 'active' : '' %>"> 
                        <% }) %>
                        <div class="wishlist-btn" data-productid="<%= product._id.toString() %>">
                            <i class="<%= wishlistProductIds.includes(product._id.toString()) ? 'fa-solid' : 'fa-regular' %> fa-heart"></i>
                        </div>
                        
                    </div>
                    <a href="/product/<%= product._id %>"class="product-link" >
                        <div class="product-details productDetails">
                            <p class="productBrandname"><%= product.brand %></p>
                             <p class="product-name productName"><%= product.productName %></p> 
             
                             <% if (product.discountedPrice && product.discountedPrice < product.price) { %>
                                 <p class="price productPrice">
                                     Rs. <%= product.discountedPrice %>  
                                     <span class="original-price originalPrice">Rs. <%= product.price %></span> 
                                     <span class="discount">( <%= product.finalDiscount %>% OFF )</span>
                                 </p>
                             <% } else { %>
                                 <p class=" productPrice">Rs. <%= product.price %></p>
                             <% } %>
                             
                             <% if (product.rating) { %>
                                 <p class="product-rating productRating">⭐ <%= product.rating %>/5</p>
                             <% } %>
                         </div>
                    </a>
                        
                    </div>
                <% }) %>
            </div>
            <!-- Pagination -->
            <div id="pagination">
                <% if (currentPage > 1) { %>
                    <a href="?page=<%= currentPage - 1 %>&sort=<%= sortOption %>&category=<%= categoryIds.join('&category=') %>&price=<%= price.join(',') %>
                    <% size.forEach(s => { %>&size=<%= s %><% }) %>&color=<%= colorSelected.join('&color=') %>">
                        Previous
                    </a>
                <% } %>
                
                <% for (let i = 1; i <= totalPages; i++) { %>
                    <a href="?page=<%= i %>&sort=<%= sortOption %>&category=<%= categoryIds.join('&category=') %>&price=<%= price.join(',') %>
                    <% size.forEach(s => { %>&size=<%= s %><% }) %>&color=<%= colorSelected.join('&color=') %>"
                       class="<%= currentPage === i ? 'active' : '' %>">
                        <%= i %>
                    </a>
                <% } %>
                
                <% if (currentPage < totalPages) { %>
                    <a href="?page=<%= currentPage + 1 %>&sort=<%= sortOption %>&category=<%= categoryIds.join('&category=') %>&price=<%= price.join(',') %>
                    <% size.forEach(s => { %>&size=<%= s %><% }) %>&color=<%= colorSelected.join('&color=') %>">
                        Next
                    </a>
                <% } %>
            </div>
            
            </div>
            
            </div>
    
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll(".productscard").forEach(card => {
            let images = card.querySelectorAll(".product-slide");
            let index = 0;
            let interval;
    
            card.addEventListener("mouseenter", () => {
                if (images.length > 1) { // Only animate if multiple images exist
                    interval = setInterval(() => {
                        images.forEach(img => img.classList.remove("active"));
                        images[index].classList.add("active");
                        index = (index + 1) % images.length;
                    }, 1000);
                    card.dataset.interval = interval;
                }
            });
    
            card.addEventListener("mouseleave", () => {
                clearInterval(interval);
                images.forEach(img => img.classList.remove("active"));
                images[0].classList.add("active"); // Reset to first image
            });
    
            // Wishlist Button Click
document.querySelectorAll(".wishlist-btn i").forEach((wishlistBtn) => {
    wishlistBtn.addEventListener("click", (event) => {
        event.stopPropagation();
        
        let isWishlisted = wishlistBtn.classList.contains("fa-solid"); // Check if it's already wishlisted
        
        Swal.fire({
            title: isWishlisted ? "Remove from Wishlist?" : "Add to Wishlist?",
            text: isWishlisted ? "Are you sure you want to remove this item from your wishlist?" : "Do you want to add this item to your wishlist?",
            icon: "question",
            showCancelButton: true,
            confirmButtonColor: "#d33",
            cancelButtonColor: "#3085d6",
            confirmButtonText: isWishlisted ? "Yes, Remove it!" : "Yes, Add it!",
        }).then((result) => {
            if (result.isConfirmed) {
                // Toggle wishlist class
                wishlistBtn.classList.toggle("fa-regular");
                wishlistBtn.classList.toggle("fa-solid");
                wishlistBtn.style.color = wishlistBtn.classList.contains("fa-solid") ? "red" : "black";

                // Here, you should make an AJAX call to update the wishlist status in the database
                let productId = wishlistBtn.closest(".wishlist-btn").getAttribute("data-productid"); // Get product ID
                updateWishlist(productId, !isWishlisted); // Pass new wishlist status
            }
        });
    });
});

// Function to update wishlist on the server (AJAX request)
function updateWishlist(productId, addToWishlist) {
    fetch("/product/wishlist/updateproducts", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify({ productId, addToWishlist }),
    })
    .then((response) => response.json())
    .then((data) => {
        if (data.success) {
            console.log("Wishlist updated successfully!");
        } else {
            console.error("Failed to update wishlist.");
        }
    })
    .catch((error) => console.error("Error:", error));
}

        });
    });
    document.getElementById("toggleFilters").addEventListener("click", function () {
    var filters = document.getElementById("filtersContainer");
    if (filters.classList.contains("d-none")) {
        filters.classList.remove("d-none");
    } else {
        filters.classList.add("d-none");
    }
});

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/main.js"></script>
</body>
</html>
    
    